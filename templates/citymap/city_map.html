<!-- city_map.html -->
{% extends 'homepage/homepage.html' %}
{% load static %}

{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lviv Choropleth Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{% static 'css/map_style.css' %}">
    <style>
        .leaflet-popup-content {
            width: 250px; /* Adjust width as needed */
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map', {
            dragging: false,
            scrollWheelZoom: false,
            maxZoom: 11,
            minZoom: 11
        }).setView([49.842957, 24.031111], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var districtsData = {% include 'citymap/dist_json.json' %};

        districtsData.forEach(function(districtData) {
            const coordinates = districtData.coordinates.map(function (point) {
                return [point.lat, point.lon];
            });
            const districtBoundary = L.polygon(coordinates, {
                fillColor: 'darkblue',
                fillOpacity: 0.5,
                color: 'darkblue',
                weight: 2
            }).addTo(map);
            districtBoundary.bindPopup('<div id="district-popup-content"></div>');

            districtBoundary.on('click', function (e) {
                // Fetch and display project titles associated with the clicked district
                fetchProjects(districtData.name);
            });

            districtBoundary.on('mouseover', function (e) {
                districtBoundary.setStyle({
                    fillOpacity: 1
                });
            });

            districtBoundary.on('mouseout', function (e) {
                districtBoundary.setStyle({
                    fillOpacity: 0.5
                });
            });
        });

        // Function to fetch and display project titles associated with a district
        function fetchProjects(districtName) {
            fetch('/projects/?district=' + districtName)
            .then(response => response.json())
            .then(data => {
                const projectsContainer = document.getElementById('district-popup-content');
                projectsContainer.innerHTML = '<h3>Projects in ' + districtName + ':</h3>';
                if (data.length > 0) {
                    const projectTitles = data.map(project => '<a href="/projects/' + project.id + '">' + project.name + '</a>');
                    projectsContainer.innerHTML += projectTitles.join('<br>');
                } else {
                    projectsContainer.innerHTML += '<p>No projects available :(</p>';
                }
            })
            .catch(error => console.error('Error fetching projects:', error));
        }
    </script>
</body>
</html>
{% endblock %}
